<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making Animated Win Probability Charts with cfbscrapR • cfbscrapR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Making Animated Win Probability Charts with cfbscrapR">
<meta property="og:description" content="cfbscrapR">
<meta property="og:image" content="https://raw.githubusercontent.com/saiemgilani/cfbscrapR/master/man/figures/card.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@cfbscrapR">
<meta name="twitter:site" content="@cfbscrapR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cfbscrapR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.22</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-question-circle-o"></span>
     
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Vignettes</a>
    </li>
    <li class="dropdown-header">Introductory</li>
    <li>
      <a href="../articles/intro.html">CFB Analytics with cfbscrapR</a>
    </li>
    <li>
      <a href="../articles/Animated_WP_Plotting.html">Animated Win Probability Plots</a>
    </li>
    <li>
      <a href="../articles/fourth_down_plot_tutorial.html">Fourth Down Tendency Plots</a>
    </li>
    <li class="dropdown-header">Expected Points Model Fundamentals</li>
    <li>
      <a href="../articles/College-Football-Expected-Points-Model-Fundamentals-Part-I.html">Part 1 - Model Definition</a>
    </li>
    <li>
      <a href="../articles/College-Football-Expected-Points-Model-Fundamentals-Part-II.html">Part 2 - Regression Models</a>
    </li>
    <li>
      <a href="../articles/College-Football-Expected-Points-Model-Fundamentals-Part-III.html">Part 3 - History of Expected Points Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/cfbscrapR">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/saiemgilani/cfbscrapR/">
    <span class="fa fa-github fa-lg"></span>
     
    GitHub
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Animated_WP_Plotting_files/header-attrs-2.3/header-attrs.js"></script><script src="Animated_WP_Plotting_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Making Animated Win Probability Charts with cfbscrapR</h1>
                        <h4 class="author">Jared Lee | <span class="citation">@JaredDLee</span>
</h4>
            
            <h4 class="date">2020-09-24</h4>
      
      
      <div class="hidden name"><code>Animated_WP_Plotting.Rmd</code></div>

    </div>

    
    
<p>Have you ever wanted to make an <a href="https://kazink36.github.io/images/animated_wp_ex_wide.gif">animated win probability chart</a> for college football like <a href="https://twitter.com/LeeSharpeNFL">Lee Sharpe</a> makes for <a href="https://twitter.com/LeeSharpeNFL/status/1300526539344289792">the NFL</a>? This document will walk you step-by-step through the process of adapting <a href="https://github.com/leesharpe/nfldata/blob/master/code/wpchart.R">Sharpe’s code</a> to college football using data from <a href="collegefootballdata.com">CollegeFootballData.com</a> collected using the <code>cfbscrapR</code> package for R.</p>
<p>-<a href="https://twitter.com/JaredDLee">Jared Lee</a></p>
<div id="load-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#load-packages" class="anchor"></a>Load Packages</h2>
<p>We’re going to need several packages to generate the winning percentage plot: <code>tidyverse</code> for easy data wrangling, string manipulation, and plotting, <code>glue</code> to easily make the labels, <code>ggimage</code> to put the logos on the plot, and <code>animation</code> to actually build the GIF.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://yihui.name/animation">animation</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/tidyverse/glue">glue</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/GuangchuangYu/ggimage">ggimage</a></span>)
</pre></div>
</div>
<div id="cfbscrapr" class="section level2">
<h2 class="hasAnchor">
<a href="#cfbscrapr" class="anchor"></a>cfbscrapR</h2>
<p>We’ll start by picking a team, a week, and a year and using <code>cfbscrapR</code>’s functions to pull the play-by-play and the game info. <code><a href="../reference/cfb_pbp_data.html">cfb_pbp_data()</a></code> will grab the play-by-play info and make sure that epa_wpa is TRUE to get the win probabilities for the plot. <code><a href="../reference/cfb_game_info.html">cfb_game_info()</a></code> will pull the game info such as the home and away team and the result.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">team</span> <span class="op">&lt;-</span> <span class="st">"Utah"</span>
<span class="kw">week</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="kw">year</span> <span class="op">&lt;-</span> <span class="fl">2019</span>
<span class="kw">game_pbp</span> <span class="op">&lt;-</span> <span class="kw">cfbscrapR</span>::<span class="fu"><a href="../reference/cfb_pbp_data.html">cfb_pbp_data</a></span>(<span class="kw">year</span>, team = <span class="kw">team</span>, week = <span class="kw">week</span>, epa_wpa = <span class="fl">TRUE</span>)
<span class="kw">game</span> <span class="op">&lt;-</span> <span class="kw">cfbscrapR</span>::<span class="fu"><a href="../reference/cfb_game_info.html">cfb_game_info</a></span>(<span class="kw">year</span>, team = <span class="kw">team</span>, week = <span class="kw">week</span>)
</pre></div>
<p>We’ll also use the <code><a href="../reference/cfb_team_info.html">cfb_team_info()</a></code> function to pull the color and logo information and add it to the game info. We’ll also add in a <code>result</code> column that is the score difference between the home and the away teams that we’ll use later.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">team_info</span> <span class="op">&lt;-</span> <span class="kw">cfbscrapR</span>::<span class="fu"><a href="../reference/cfb_team_info.html">cfb_team_info</a></span>()
<span class="kw">team_logos</span> <span class="op">&lt;-</span> <span class="kw">team_info</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">school</span>, <span class="kw">color</span>, <span class="kw">alt_color</span>, <span class="kw">logos</span>, <span class="kw">alt_name2</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(logo = <span class="fu">map</span>(<span class="kw">logos</span>, <span class="kw">magrittr</span>::<span class="kw"><a href="https://rdrr.io/pkg/magrittr/man/aliases.html">extract2</a></span>, <span class="fl">1</span>),
         logo = <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw">logo</span>)) <span class="op">%&gt;%</span> <span class="fu">select</span>(<span class="op">-</span><span class="kw">logos</span>)
<span class="kw">game</span> <span class="op">&lt;-</span> <span class="kw">game</span> <span class="op">%&gt;%</span> 
  <span class="fu">inner_join</span>(<span class="kw">team_logos</span>, by = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"away_team"</span> = <span class="st">"school"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu">rename</span>(away_logo = <span class="kw">logo</span>, away_color = <span class="kw">color</span>, away_alt_color = <span class="kw">alt_color</span>, away_abr = <span class="kw">alt_name2</span>) <span class="op">%&gt;%</span> 
  <span class="fu">inner_join</span>(<span class="kw">team_logos</span>, by = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"home_team"</span> = <span class="st">"school"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu">rename</span>(home_logo = <span class="kw">logo</span>, home_color = <span class="kw">color</span>, home_alt_color = <span class="kw">alt_color</span>, home_abr = <span class="kw">alt_name2</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(result = <span class="kw">home_points</span> <span class="op">-</span> <span class="kw">away_points</span>) <span class="op">%&gt;%</span>
  <span class="fu">rename</span>(home_score = <span class="kw">home_points</span>, away_score = <span class="kw">away_points</span>)
</pre></div>
<p>To build the labels, we’re going to use a custom function to pull the player names out of the play text. <a href="https://twitter.com/SaiemGilani">Saiem Gilani</a> wrote the bulk of the regular expressions here to get the names. They may not catch all player names, especially for sacks, kick returns, and punt returns.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">add_player_cols</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">pbp</span>) {
  <span class="co">## Extract player names</span>
  <span class="co"># RB names </span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      rush_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">rush</span> <span class="op">==</span> <span class="fl">1</span>, 
                           <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.{0,25} )run |(.{0,25} )\\d{0,2} Yd Run"</span>), <span class="fl">NA</span>),
      rush_player = <span class="fu">str_remove</span>(<span class="kw">rush_player</span>, <span class="st">" run | \\d+ Yd Run"</span>))
  <span class="co"># QB names </span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      pass_player = 
        <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> != <span class="st">"Passing Touchdown"</span>, 
          <span class="fu">str_extract</span>(<span class="kw">play_text</span>, 
            <span class="st">"pass from (.*?) \\(|(.{0,30} )pass |(.+) sacked by|(.+) sacked for|(.{0,30} )incomplete "</span>), <span class="fl">NA</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">"pass | sacked by| sacked for| incomplete"</span>),
      pass_player = <span class="fu">if_else</span>(<span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Passing Touchdown"</span>, 
                            <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"pass from(.+)"</span>), <span class="kw">pass_player</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">"pass from "</span>), 
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">"\\(.+\\)"</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">" \\,"</span>),
      pass_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Passing Touchdown"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">pass_player</span>),
                           <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.+)pass complete to"</span>), <span class="kw">pass_player</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">" pass complete to(.+)"</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">" pass complete to"</span>),
      pass_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Passing Touchdown"</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">pass_player</span>),
                           <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.+)pass,to"</span>), <span class="kw">pass_player</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">" pass,to(.+)"</span>),
      pass_player = <span class="fu">str_remove</span>(<span class="kw">pass_player</span>, <span class="st">" pass,to"</span>))
  <span class="co">## Receiver names</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      receiver_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">pass</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"to (.+)"</span>), <span class="fl">NA</span>),
      receiver_player = <span class="fu">if_else</span>(<span class="fu">str_detect</span>(<span class="kw">play_text</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">"Yd pass"</span>, ignore_case = <span class="fl">TRUE</span>)),
                                <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.{0,25} )\\d{0,2} Yd pass"</span>),
                                <span class="kw">receiver_player</span>),
      receiver_player = <span class="fu">if_else</span>(<span class="fu">str_detect</span>(<span class="kw">play_text</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">"Yd TD pass"</span>, ignore_case = <span class="fl">TRUE</span>)),
                                <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.{0,25} )\\d{0,2} Yd TD pass"</span>),
                                <span class="kw">receiver_player</span>),
      receiver_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Sack"</span> <span class="op">|</span>
                               <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Interception Return"</span> <span class="op">|</span>
                               <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Interception Return Touchdown"</span> <span class="op">|</span>
                               (<span class="kw">play_type</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Fumble Recovery (Opponent)"</span>,
                                                 <span class="st">"Fumble Recovery (Opponent) Touchdown"</span>) <span class="op">&amp;</span>
                                <span class="fu">str_detect</span>(<span class="kw">play_text</span>, <span class="st">"sacked"</span>)), <span class="fl">NA</span>, <span class="kw">receiver_player</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"to "</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"\\,.+"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"for (.+)"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" (\\d{1,2})"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" Yd pass"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" Yd TD pass"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"pass complete to"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">"penalty"</span>, ignore_case = <span class="fl">TRUE</span>)),
      receiver_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="op">!</span><span class="fu">str_detect</span>(<span class="kw">receiver_player</span>, <span class="st">"III"</span>),
                               <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"[A-Z]{3,}+"</span>), <span class="kw">receiver_player</span>),
      receiver_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="op">!</span><span class="fu">str_detect</span>(<span class="kw">receiver_player</span>, <span class="st">"III"</span>),
                               <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"[A-Z]{3,}+"</span>), <span class="kw">receiver_player</span>),
      receiver_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="op">!</span><span class="fu">str_detect</span>(<span class="kw">receiver_player</span>, <span class="st">"III"</span>),
                               <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"[A-Z]{3,}+"</span>), <span class="kw">receiver_player</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" &amp;"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"A&amp;M"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" ST"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" GA"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" UL"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" FL"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" OH"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" NC"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" É"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">" fumbled,"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"the (.+)"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"pass incomplete to"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"(.+)pass incomplete to"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"(.+)pass incomplete"</span>),
      receiver_player = <span class="fu">str_remove</span>(<span class="kw">receiver_player</span>, <span class="st">"pass incomplete"</span>))
  
  <span class="co">## Extract player names</span>
  <span class="co">## Sack player names</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      sack_players = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Sack"</span>, 
                            <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"sacked by(.+)"</span>), <span class="fl">NA</span>),
      sack_players = <span class="fu">str_remove</span>(<span class="kw">sack_players</span>, <span class="st">"for (.+)"</span>),
      sack_players = <span class="fu">str_remove</span>(<span class="kw">sack_players</span>, <span class="st">"(.+)by"</span>),
      sack_player1 = <span class="fu">str_remove</span>(<span class="kw">sack_players</span>, <span class="st">"and (.+)"</span>),
      sack_player2 = <span class="fu">if_else</span>(<span class="fu">str_detect</span>(<span class="kw">sack_players</span>, <span class="st">"and (.+)"</span>), 
                             <span class="fu">str_remove</span>(<span class="kw">sack_players</span>, <span class="st">" (.+) and"</span>), <span class="kw">NULL</span>)) 
  <span class="co">## Interception player names</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      interception_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> (<span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Interception Return"</span><span class="op">|</span> 
                                                <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Interception Return Touchdown"</span>),
                                   <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"intercepted (.+)"</span>), <span class="fl">NA</span>),
      interception_player = <span class="fu">if_else</span>(<span class="fu">str_detect</span>(<span class="kw">play_text</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">"Yd pass"</span>, ignore_case = <span class="fl">TRUE</span>)),
                                <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.{0,25} )\\d{0,2} Yd pass"</span>),
                                <span class="kw">interception_player</span>),
      interception_player = <span class="fu">if_else</span>(<span class="fu">str_detect</span>(<span class="kw">play_text</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">"Yd Interception Return"</span>, ignore_case = <span class="fl">TRUE</span>)),
                                <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">"(.{0,25} )\\d{0,2} Yd Interception Return"</span>),
                                <span class="kw">interception_player</span>),
      interception_player = <span class="fu">str_remove</span>(<span class="kw">interception_player</span>, <span class="st">"return (.+)"</span>),
      interception_player = <span class="fu">str_remove</span>(<span class="kw">interception_player</span>, <span class="st">"(.+) intercepted "</span>),
      interception_player = <span class="fu">str_remove</span>(<span class="kw">interception_player</span>, <span class="st">"intercepted"</span>),
      interception_player = <span class="fu">str_remove</span>(<span class="kw">interception_player</span>, <span class="st">" Yd Interception Return"</span>),
      interception_player = <span class="fu">str_remove</span>(<span class="kw">interception_player</span>, <span class="st">" (\\d{1,2})"</span>))
  
  <span class="co">## Punter Name</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      punter_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu">str_detect</span>(<span class="kw">play_type</span>, <span class="st">"Punt"</span>),
                             <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">".{0,25} punt"</span>), <span class="fl">NA</span>),
      punter_player = <span class="fu">str_remove</span>(<span class="kw">punter_player</span>,<span class="st">" punt"</span>))
  
  <span class="co">## Punt Returner</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      punt_returner_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu">str_detect</span>(<span class="kw">play_type</span>, <span class="st">"Punt"</span>), 
                                    <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">", .{0,25} returns"</span>), <span class="fl">NA</span>),
      punt_returner_player = <span class="fu">str_remove</span>(<span class="kw">punt_returner_player</span>, <span class="st">", "</span>),
      punt_returner_player = <span class="fu">str_remove</span>(<span class="kw">punt_returner_player</span>, <span class="st">" returns"</span>)) 
  
  <span class="co">## Kickoff Specialist Name</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span>(
      kickoff_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu">str_detect</span>(<span class="kw">play_type</span>, <span class="st">"Kickoff"</span>),
                             <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="st">".{0,25} kickoff"</span>), <span class="fl">NA</span>),
      kickoff_player = <span class="fu">str_remove</span>(<span class="kw">kickoff_player</span>,<span class="st">" kickoff"</span>))
  
  <span class="co">## Kickoff Returner</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span>(
      kickoff_returner_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu">str_detect</span>(<span class="kw">play_type</span>,<span class="st">"ickoff"</span>),
                                       <span class="fu">str_extract</span>(<span class="kw">play_text</span>,<span class="st">", .{0,25} return"</span>), <span class="fl">NA</span>),
      kickoff_returner_player = <span class="fu">str_remove</span>(<span class="kw">kickoff_returner_player</span>,<span class="st">", "</span>),
      kickoff_returner_player = <span class="fu">str_remove</span>(<span class="kw">kickoff_returner_player</span>,<span class="st">" return"</span>)) 
  <span class="co">## Field Goal Kicker</span>
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span>(
      fg_kicker_player = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu">str_detect</span>(<span class="kw">play_type</span>, <span class="st">"Field Goal"</span>),
                             <span class="fu">str_extract</span>(<span class="kw">play_text</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">"(.{0,25} )\\d{0,2} yd field goal| | (.{0,25} )\\d{0,2} yd fg"</span>, ignore_case = <span class="fl">TRUE</span>)), <span class="fl">NA</span>),
      fg_kicker_player = <span class="fu">str_remove</span>(<span class="kw">fg_kicker_player</span>, <span class="fu"><a href="https://rdrr.io/r/base/regex.html">regex</a></span>(<span class="st">" Yd Field Goal|Yd FG"</span>, ignore_case = <span class="fl">TRUE</span>)),
      fg_kicker_player = <span class="fu">str_remove</span>(<span class="kw">fg_kicker_player</span>,<span class="st">" (\\d{1,2})"</span>)
      )
      
  
  <span class="kw">pbp</span> <span class="op">&lt;-</span> <span class="kw">pbp</span> <span class="op">%&gt;%</span>
    <span class="fu">rename</span>(
      rusher_player_name = <span class="kw">rush_player</span>,
      receiver_player_name = <span class="kw">receiver_player</span>,
      passer_player_name = <span class="kw">pass_player</span>,
      sack_player_name = <span class="kw">sack_player1</span>,
      sack_player_name2 = <span class="kw">sack_player2</span>,
      interception_player_name = <span class="kw">interception_player</span>,
      punter_player_name = <span class="kw">punter_player</span>,
      fg_kicker_player_name = <span class="kw">fg_kicker_player</span>,
      kickoff_player_name = <span class="kw">kickoff_player</span>,
      kickoff_returner_player_name = <span class="kw">kickoff_returner_player</span>,
      punt_returner_player_name = <span class="kw">punt_returner_player</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">pbp</span>)
}
</pre></div>
<p>Now we are ready to transform our play-by-play data frame to match what we need to work with Lee Sharpe’s animation code. First, we will rename several columns that are similar between <code>cfbscrapR</code> and <code>nflfastR</code> to match <code>nflfastR</code>’s column names. Then we need to create a few new columns that <code>cfbscrapR</code> doesn’t have. <code>game_seconds_remaining</code> is really just renaming <code>TimeSecsRem</code> but correcting for the half. <code>result</code> grabs from the game information and is the difference in the home and away score. We create the <code>time</code> column to use as the clock on the right side of the animation. Finally, we use our custom <code>add_player_cols()</code> function to add the player names to our data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">game_pbp</span> <span class="op">&lt;-</span> <span class="kw">game_pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span>(qtr = <span class="kw">period</span>, wp = <span class="kw">wp_before</span>, posteam = <span class="kw">offense_play</span>, defteam = <span class="kw">defense_play</span>,
         away_team = <span class="kw">away</span>, home_team = <span class="kw">home</span>, play_id = <span class="kw">game_play_number</span>,
         posteam_score = <span class="kw">offense_score</span>, defteam_score = <span class="kw">defense_score</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(game_seconds_remaining = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">half</span> <span class="op">==</span> <span class="fl">1</span>, <span class="kw">TimeSecsRem</span> <span class="op">+</span> <span class="fl">1800</span>, <span class="kw">TimeSecsRem</span>),
         result = <span class="kw">game</span><span class="op">$</span><span class="kw">result</span>,
         minlabel = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">clock.minutes</span> <span class="op">&gt;=</span> <span class="fl">15</span>,
                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">clock.minutes</span> <span class="op">==</span> <span class="fl">15</span> <span class="op">&amp;</span> <span class="kw">clock.seconds</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">15</span>, <span class="kw">clock.minutes</span> <span class="op">-</span> <span class="fl">15</span>),
                           <span class="kw">clock.minutes</span>),
         minlabel = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">minlabel</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"0"</span>, <span class="kw">minlabel</span>), <span class="kw">minlabel</span>),
         seclabel = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">clock.seconds</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"0"</span>, <span class="kw">clock.seconds</span>), <span class="kw">clock.seconds</span>),
         time = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">minlabel</span>, <span class="st">":"</span>, <span class="kw">seclabel</span>)) <span class="op">%&gt;%</span>
  <span class="fu">add_player_cols</span>()
</pre></div>
<p>Now that our data matches <code>nflfastR</code>, we can start to copy Lee Sharpe’s code and the bulk of the remaining code is his with a few minor adjustments to the plot, the overtime logic, and the labels. First we filter out plays that don’t have a win percentage and fix the win probability so that it is always the probability of the away team winning.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">base_wp_data</span> <span class="op">&lt;-</span> <span class="kw">game_pbp</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">wp</span>)) <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span>(s = <span class="kw">game_seconds_remaining</span>,
         wp = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">posteam</span> <span class="op">==</span> <span class="kw">away_team</span>, <span class="kw">wp</span>, <span class="fl">1</span> <span class="op">-</span> <span class="kw">wp</span>))
</pre></div>
<p>Then we fix the plays without a wpa.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co"># fix if play other than last is NA</span>
<span class="co">for</span> (<span class="kw">r</span> <span class="co">in</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">base_wp_data</span>)<span class="op">-</span><span class="fl">1</span>)<span class="op">:</span><span class="fl">1</span>) {
  <span class="co">if</span> (<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>]) <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wpa</span>[<span class="kw">r</span>]))
  {
    <span class="kw">target_wp</span> <span class="op">&lt;-</span> <span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span><span class="op">+</span><span class="fl">1</span>]
    <span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wpa</span>[<span class="kw">r</span>] <span class="op">&lt;-</span> <span class="kw">target_wp</span> <span class="op">-</span> <span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>]
  }
}
<span class="co"># fix if last play is NA</span>
<span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wpa</span>[<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">base_wp_data</span>)])) {
  <span class="kw">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">base_wp_data</span>)
  <span class="kw">move_to</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">game</span><span class="op">$</span><span class="kw">result</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">game</span><span class="op">$</span><span class="kw">result</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>))
  <span class="kw">delta</span> <span class="op">&lt;-</span> <span class="kw">move_to</span> <span class="op">-</span> <span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>]
  <span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">wpa</span>[<span class="kw">r</span>] <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">base_wp_data</span><span class="op">$</span><span class="kw">posteam</span>[<span class="kw">r</span>] <span class="op">==</span> <span class="kw">game</span><span class="op">$</span><span class="kw">away_team</span>, <span class="kw">delta</span>, <span class="op">-</span><span class="kw">delta</span>)
}
</pre></div>
<p>Now we create the labels. This generates labels for any play that had a change in the winning percentage of more than 10 percentage points. We’ll also simplify our data frame by only selecting the relevant columns for our plots.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">wp_data</span> <span class="op">&lt;-</span> <span class="kw">base_wp_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span>(
    helped=<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">wpa</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="kw">posteam</span>, <span class="kw">defteam</span>),
    text = 
      <span class="fu">case_when</span>(
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Kickoff"</span> <span class="op">&amp;</span> 
         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">kickoff_returner_player_name</span>) <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{kickoff_returner_player_name} KR"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Rush"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{rusher_player_name} Rush"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Pass Reception"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{receiver_player_name} Catch"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Sack"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{sack_player_name} SACK"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Punt"</span> <span class="op">~</span> <span class="st">""</span>,<span class="co">#glue("{punt_returner_player_name} PR"),</span>
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Pass Incompletion"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{passer_player_name} Incomplete"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Opponent)"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} FUMBLE"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Penalty"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"PENALTY"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Missed"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} FG MISS"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Passing Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{receiver_player_name} TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Rushing Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{rusher_player_name} TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Good"</span> <span class="op">&amp;</span>
         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">fg_kicker_player_name</span>) <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{fg_kicker_player_name} FG GOOD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Good"</span> <span class="op">&amp;</span>
         <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">fg_kicker_player_name</span>) <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} FG GOOD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Timeout"</span> <span class="op">~</span> <span class="st">""</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Interception Return"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{interception_player_name} INT"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Own)"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{rusher_player_name} Rush"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Blocked Field Goal"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} FG BLK"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Return (Offense)"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{kickoff_returner_player_name} KR"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Blocked Punt"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{defteam} PUNT BLK"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Interception Return Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{interception_player_name} DEF TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Return Touchdown"</span> <span class="op">&amp;</span> 
         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">kickoff_returner_player_name</span>) <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{kickoff_returner_player_name} KR TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Punt Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{punt_returner_player_name} PR TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Opponent) Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{defteam} FUMBLE TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Fumble Return Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{defteam} FUMBLE TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Safety"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"SAFETY"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Punt Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} PR FUMBLE TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} KR FUMBLE TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Punt Return Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{punt_returner_player_name} PR TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Uncategorized"</span> <span class="op">~</span> <span class="st">""</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Blocked Punt Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{defteam} PUNT BLK TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"placeholder"</span> <span class="op">~</span> <span class="st">""</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Missed Field Goal Return"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{posteam} FG MISS"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Missed Field Goal Return Touchdown"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{defteam} FGR TD"</span>),
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>) <span class="op">&gt;</span> <span class="fl">0.1</span> <span class="op">&amp;</span> <span class="kw">play_type</span> <span class="op">==</span> <span class="st">"Defensive 2pt Conversion"</span> <span class="op">~</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{defteam} DEF 2PT"</span>),
       <span class="fl">TRUE</span> <span class="op">~</span> <span class="st">""</span>),
    text = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">text</span> <span class="op">==</span> <span class="st">""</span>,<span class="st">""</span>, <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{text}\n{helped} +{abs(round(100*wpa))}%"</span>)),
    away_score = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">posteam</span> <span class="op">==</span> <span class="kw">away_team</span>, <span class="kw">posteam_score</span>, <span class="kw">defteam_score</span>),
    home_score = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">posteam</span> <span class="op">==</span> <span class="kw">away_team</span>, <span class="kw">defteam_score</span>, <span class="kw">posteam_score</span>)) <span class="op">%&gt;%</span> 
  <span class="fu">select</span>(<span class="kw">play_id</span>, <span class="kw">qtr</span>, <span class="kw">time</span>, <span class="kw">s</span>, <span class="kw">wp</span>, <span class="kw">wpa</span>, <span class="kw">posteam</span>, <span class="kw">away_score</span>, <span class="kw">home_score</span>, <span class="kw">text</span>)
</pre></div>
<p>This is where the real magic happens. Sharpe’s code will iterate over the labels and try to determine valid locations for each one.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="co"># points for plotting</span>
<span class="kw">x_max</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="kw">x_lab_min</span> <span class="op">&lt;-</span> <span class="fl">3600</span> <span class="op">-</span> <span class="fl">250</span>
<span class="kw">x_lab_max</span> <span class="op">&lt;-</span> <span class="kw">x_max</span> <span class="op">+</span> <span class="fl">250</span>
<span class="kw">x_score</span> <span class="op">&lt;-</span> <span class="fl">320</span> <span class="op">-</span> <span class="kw">x_max</span>
<span class="co"># determine the location of the label</span>
<span class="kw">wp_data</span><span class="op">$</span><span class="kw">x_text</span> <span class="op">&lt;-</span> <span class="fl">NA</span>
<span class="kw">wp_data</span><span class="op">$</span><span class="kw">y_text</span> <span class="op">&lt;-</span> <span class="fl">NA</span>
<span class="kw">wp_data</span> <span class="op">&lt;-</span> <span class="kw">wp_data</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="kw">wpa</span>)))

<span class="kw">seq_fix</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">start</span>, <span class="kw">end</span>, <span class="kw">move</span>)
{
  <span class="co">if</span> (<span class="kw">move</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="kw">start</span> <span class="op">&lt;</span> <span class="kw">end</span>) <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">end</span>)
  <span class="co">if</span> (<span class="kw">move</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="kw">start</span> <span class="op">&gt;</span> <span class="kw">end</span>) <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">end</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">start</span>, <span class="kw">end</span>, <span class="kw">move</span>))
}

<span class="co">for</span> (<span class="kw">r</span> <span class="co">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">text</span> != <span class="st">""</span>))
{
  <span class="co"># ordered list of spots this label could go</span>
  <span class="kw">y_side</span> <span class="op">&lt;-</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">&gt;=</span> <span class="fl">0.5</span>
  <span class="co">if</span> (<span class="kw">y_side</span>)
  {
    <span class="kw">y_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.1</span>), <span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span>))
  } <span class="co">else</span> {
    <span class="kw">y_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span>), <span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.1</span>))
  }
  <span class="co"># iterate, see if this spot is valid</span>
  <span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">y_spots</span>))
  {
    <span class="kw">valid</span> <span class="op">&lt;-</span> <span class="fl">TRUE</span>
    <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">wp_data</span> <span class="op">%&gt;%</span> 
             <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">y_spots</span>[<span class="kw">i</span>] <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="kw">wp</span> <span class="op">&amp;</span> <span class="kw">wp</span> <span class="op">&lt;</span> <span class="kw">y_spots</span>[<span class="kw">i</span>] <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                    <span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">300</span> <span class="op">&lt;</span> <span class="kw">s</span> <span class="op">&amp;</span> <span class="kw">s</span> <span class="op">&lt;</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">300</span>)) <span class="op">&gt;</span> <span class="fl">0</span>)
    {
      <span class="co"># too close to the WP line</span>
      <span class="kw">valid</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
    }
    <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">wp_data</span> <span class="op">%&gt;%</span> 
             <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">y_spots</span>[<span class="kw">i</span>] <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="kw">y_text</span> <span class="op">&amp;</span> <span class="kw">y_text</span> <span class="op">&lt;</span> <span class="kw">y_spots</span>[<span class="kw">i</span>] <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                    <span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">600</span> <span class="op">&lt;</span> <span class="kw">x_text</span> <span class="op">&amp;</span> <span class="kw">x_text</span> <span class="op">&lt;</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">600</span>)) <span class="op">&gt;</span> <span class="fl">0</span>)
    {
      <span class="co"># too close to another label</span>
      <span class="kw">valid</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
    }
    <span class="co">if</span> (<span class="kw">valid</span>)
    {
      <span class="co"># we found a spot for it, store and break loop</span>
      <span class="kw">wp_data</span><span class="op">$</span><span class="kw">x_text</span>[<span class="kw">r</span>] <span class="op">&lt;-</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] 
      <span class="kw">wp_data</span><span class="op">$</span><span class="kw">y_text</span>[<span class="kw">r</span>] <span class="op">&lt;-</span> <span class="kw">y_spots</span>[<span class="kw">i</span>]
      <span class="co">break</span>
    }
  }
  <span class="co"># try x_spots?</span>
  <span class="co">if</span> (<span class="op">!</span><span class="kw">valid</span>)
  {
    <span class="kw">x_side</span> <span class="op">&lt;-</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">&gt;=</span> <span class="fl">1800</span>
    <span class="co">if</span> (<span class="kw">x_side</span>)
    {
      <span class="kw">x_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">400</span>, <span class="kw">x_lab_max</span>, <span class="op">-</span><span class="fl">200</span>),
                   <span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">400</span>, <span class="kw">x_lab_min</span>, <span class="fl">200</span>))
    } <span class="co">else</span> {
      <span class="kw">x_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">400</span>, <span class="kw">x_lab_min</span>, <span class="fl">200</span>),
                   <span class="fu">seq_fix</span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">400</span>, <span class="kw">x_lab_max</span>, <span class="op">-</span><span class="fl">200</span>))
    }
    <span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">x_spots</span>))
    {
      <span class="kw">valid</span> <span class="op">&lt;-</span> <span class="fl">TRUE</span>
      <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">wp_data</span> <span class="op">%&gt;%</span> 
               <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="kw">wp</span> <span class="op">&amp;</span> <span class="kw">wp</span> <span class="op">&lt;</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                      <span class="kw">x_spots</span>[<span class="kw">i</span>] <span class="op">-</span> <span class="fl">300</span> <span class="op">&lt;</span> <span class="kw">s</span> <span class="op">&amp;</span> <span class="kw">s</span> <span class="op">&lt;</span> <span class="kw">x_spots</span>[<span class="kw">i</span>] <span class="op">+</span> <span class="fl">300</span>)) <span class="op">&gt;</span> <span class="fl">0</span>)
      {
        <span class="co"># too close to the WP line</span>
        <span class="kw">valid</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
      }
      <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">wp_data</span> <span class="op">%&gt;%</span> 
               <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="kw">y_text</span> <span class="op">&amp;</span> <span class="kw">y_text</span> <span class="op">&lt;</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>] <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                      <span class="kw">x_spots</span>[<span class="kw">i</span>] <span class="op">-</span> <span class="fl">600</span> <span class="op">&lt;</span> <span class="kw">x_text</span> <span class="op">&amp;</span> <span class="kw">x_text</span> <span class="op">&lt;</span> <span class="kw">x_spots</span>[<span class="kw">i</span>] <span class="op">+</span> <span class="fl">600</span>)) <span class="op">&gt;</span> <span class="fl">0</span>)
      {
        <span class="co"># too close to another label</span>
        <span class="kw">valid</span> <span class="op">&lt;-</span> <span class="fl">FALSE</span>
      }
      <span class="co">if</span> (<span class="kw">valid</span>)
      {
        <span class="co"># we found a spot for it, stop loop</span>
        <span class="kw">wp_data</span><span class="op">$</span><span class="kw">x_text</span>[<span class="kw">r</span>] <span class="op">&lt;-</span> <span class="kw">x_spots</span>[<span class="kw">i</span>]
        <span class="kw">wp_data</span><span class="op">$</span><span class="kw">y_text</span>[<span class="kw">r</span>] <span class="op">&lt;-</span> <span class="kw">wp_data</span><span class="op">$</span><span class="kw">wp</span>[<span class="kw">r</span>]
        <span class="co">break</span>
      }
    }
  }
  <span class="co"># warn about the labels not placed</span>
  <span class="co">if</span> (<span class="op">!</span><span class="kw">valid</span>)
  {
    <span class="fu"><a href="https://rdrr.io/r/base/warning.html">warning</a></span>(<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"No room for ({wp_data$s[r]},{round(wp_data$wp[r], 3)}):"</span>,
                       <span class="st">"{gsub('\n',' ',wp_data$text[r])}"</span>)))
  }
}
</pre></div>
<p>Finally, we create two new rows to our data frame for the start and end of the game, filter out any other weirdness, and arrange our data frame by the order of the plays.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co"># add on WP boundaries</span>
<span class="kw">first_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(play_id = <span class="fl">0</span>, qtr = <span class="fl">1</span>, time = <span class="st">"15:00"</span>, s = <span class="fl">3600</span>,
                        wp = <span class="fl">0.5</span>, wpa = <span class="fl">NA</span>, text = <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="st">""</span>),
                        x_text = <span class="fl">3600</span>, y_text = <span class="fl">0.5</span>, away_score = <span class="fl">0</span>, home_score = <span class="fl">0</span>,
                        stringsAsFactors = <span class="fl">FALSE</span>)
<span class="kw">last_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(play_id = <span class="fl">999999</span>, qtr = <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">qtr</span>), s = <span class="kw">x_max</span> <span class="op">-</span> <span class="fl">1</span>,
                       time = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">qtr</span>) <span class="op">&gt;=</span> <span class="fl">5</span>, <span class="st">"FINAL\nOT"</span>, <span class="st">"FINAL"</span>),
                       wp = <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">game</span><span class="op">$</span><span class="kw">result</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">game</span><span class="op">$</span><span class="kw">result</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>)),
                       wpa = <span class="fl">NA</span>, text = <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="st">""</span>), x_text = <span class="kw">x_max</span>, y_text = <span class="fl">0.5</span>,
                       away_score = <span class="kw">game</span><span class="op">$</span><span class="kw">away_score</span>, home_score = <span class="kw">game</span><span class="op">$</span><span class="kw">home_score</span>,
                       stringsAsFactors = <span class="fl">FALSE</span>)
<span class="kw">wp_data</span> <span class="op">&lt;-</span> <span class="kw">wp_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">posteam</span> != <span class="st">""</span>,
         <span class="kw">wpa</span> != <span class="fl">0</span>) <span class="op">%&gt;%</span> 
  <span class="fu">bind_rows</span>(<span class="kw">first_row</span>) <span class="op">%&gt;%</span> 
  <span class="fu">bind_rows</span>(<span class="kw">last_row</span>) <span class="op">%&gt;%</span>
  <span class="fu">arrange</span>(<span class="kw">play_id</span>)
</pre></div>
</div>
<div id="plotting" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting" class="anchor"></a>Plotting</h2>
<p>Now we’re ready for plotting. The <code>draw_frame()</code> function will draw our win probability plot for any given number of seconds remaining in the game. This is where you can make any changes to the plot that you would like.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">draw_frame</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">n_sec</span>)
{
  
  <span class="co"># frame data</span>
  <span class="kw">frm_data</span> <span class="op">&lt;-</span> <span class="kw">wp_data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">s</span> <span class="op">&gt;=</span> <span class="kw">n_sec</span>)
  
  <span class="co"># output quarter changes</span>
  <span class="co">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">frm_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">qtr</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">qtr</span>))) <span class="op">==</span> <span class="fl">1</span>)
  {
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"Plotting pbp in quarter {max(frm_data$qtr)}"</span>))
  }
  
  <span class="co"># plot</span>
  <span class="kw">frm_plot</span> <span class="op">&lt;-</span> <span class="kw">frm_data</span> <span class="op">%&gt;%</span> 
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(x = <span class="kw">s</span>, y = <span class="kw">wp</span>)) <span class="op">+</span>
    <span class="fu">theme_minimal</span>() <span class="op">+</span>
    <span class="fu">geom_vline</span>(xintercept = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3600</span>, <span class="kw">x_max</span>), color = <span class="st">"#5555AA"</span>) <span class="op">+</span>
    <span class="fu">geom_segment</span>(x = <span class="op">-</span><span class="fl">3600</span>, xend = <span class="op">-</span><span class="kw">x_max</span>, y = <span class="fl">0.5</span>, yend = <span class="fl">0.5</span>, size = <span class="fl">0.75</span>) <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ggimage/man/geom_image.html">geom_image</a></span>(x = <span class="kw">x_score</span>, y = <span class="fl">0.82</span>, image = <span class="kw">game</span><span class="op">$</span><span class="kw">away_logo</span>, size = <span class="fl">0.08</span>, asp = <span class="fl">1.5</span>) <span class="op">+</span>
    <span class="fu"><a href="https://rdrr.io/pkg/ggimage/man/geom_image.html">geom_image</a></span>(x = <span class="kw">x_score</span>, y = <span class="fl">0.18</span>, image = <span class="kw">game</span><span class="op">$</span><span class="kw">home_logo</span>, size = <span class="fl">0.08</span>, asp = <span class="fl">1.5</span>) <span class="op">+</span>
    <span class="fu">geom_line</span>(<span class="fu">aes</span>(color = <span class="kw">..y..</span> <span class="op">&lt;</span> <span class="fl">.5</span>), size = <span class="fl">1</span>) <span class="op">+</span>
    <span class="fu">scale_color_manual</span>(values = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">game</span><span class="op">$</span><span class="kw">away_color</span>, <span class="kw">game</span><span class="op">$</span><span class="kw">home_color</span>)) <span class="op">+</span>
    <span class="fu">scale_x_continuous</span>(trans = <span class="st">"reverse"</span>,
                       minor_breaks = <span class="kw">NULL</span>,
                       labels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"KICK\nOFF"</span>, <span class="st">"END\nQ1"</span>, <span class="st">"HALF\nTIME"</span>, <span class="st">"END\nQ3"</span>, <span class="st">"FINAL"</span>),
                       breaks = <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">3600</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">900</span>),
                       limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3700</span>, <span class="kw">x_max</span> <span class="op">-</span> <span class="fl">490</span>)) <span class="op">+</span>
    <span class="fu">scale_y_continuous</span>(labels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{game$home_abr} 100%"</span>),
                                  <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{game$home_abr} 75%"</span>),
                                  <span class="st">"50%"</span>,
                                  <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{game$away_abr} 75%"</span>),
                                  <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"{game$away_abr} 100%"</span>)),
                       breaks = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span>),
                       limits = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fl">1</span>)) <span class="op">+</span>
    <span class="fu">coord_cartesian</span>(clip = <span class="st">"off"</span>) <span class="op">+</span>
    <span class="fu">xlab</span>(<span class="st">""</span>) <span class="op">+</span>
    <span class="fu">ylab</span>(<span class="st">""</span>) <span class="op">+</span>
    <span class="fu">labs</span>(title = <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span>(<span class="st">"Win Probability Chart: {game$season} Week {game$week} {game$away_team} @ {game$home_team}"</span>),
         caption = <span class="st">"Data from cfbscrapR, Visualization by @LeeSharpeNFL, Adapted for CFB by @JaredDLee"</span>) <span class="op">+</span>
    <span class="fu">theme</span>(legend.position = <span class="st">"none"</span>)
  
  <span class="co"># score display </span>
  <span class="kw">away_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">away_score</span>)
  <span class="kw">home_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">home_score</span>)
  
  <span class="co"># clock display</span>
  <span class="kw">qtr</span> <span class="op">&lt;-</span> <span class="fu">case_when</span>(
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">qtr</span>) <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"1st"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">qtr</span>) <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"2nd"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">qtr</span>) <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"3rd"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">qtr</span>) <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"4th"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">qtr</span>) <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"OT"</span>,
    <span class="fl">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">qtr</span>))
  )
  <span class="kw">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">time</span>, <span class="fl">1</span>)
  <span class="kw">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="kw">clock</span>, <span class="fl">1</span>, <span class="fl">1</span>) <span class="op">==</span> <span class="st">"0"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span>(<span class="kw">clock</span>, <span class="fl">2</span>, <span class="fl">100</span>), <span class="kw">clock</span>)
  <span class="kw">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">qtr</span>, <span class="st">"\n"</span>, <span class="kw">clock</span>)
  <span class="kw">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"FINAL"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">time</span>, <span class="fl">1</span>)), <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(<span class="kw">frm_data</span><span class="op">$</span><span class="kw">time</span>, <span class="fl">1</span>), <span class="kw">clock</span>)
  
  <span class="co"># add score and clock to plot</span>
  <span class="kw">frm_plot</span> <span class="op">&lt;-</span> <span class="kw">frm_plot</span> <span class="op">+</span> 
    <span class="fu">annotate</span>(<span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="kw">x_score</span>, y = <span class="fl">0.71</span>, label = <span class="kw">away_score</span>, color = <span class="kw">game</span><span class="op">$</span><span class="kw">away_color</span>, size = <span class="fl">8</span>) <span class="op">+</span>
    <span class="fu">annotate</span>(<span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="kw">x_score</span>, y = <span class="fl">0.29</span>, label = <span class="kw">home_score</span>, color = <span class="kw">game</span><span class="op">$</span><span class="kw">home_color</span>, size = <span class="fl">8</span>) <span class="op">+</span>
    <span class="fu">annotate</span>(<span class="st">"text"</span>, x = <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="kw">x_score</span>, y = <span class="fl">0.50</span>, label = <span class="kw">clock</span>, color = <span class="st">"#000000"</span>, size = <span class="fl">6</span>)
  
  <span class="co"># label key moments</span>
  <span class="kw">frm_labels</span> <span class="op">&lt;-</span> <span class="kw">frm_data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">text</span> != <span class="st">""</span>)
  <span class="kw">frm_plot</span> <span class="op">&lt;-</span> <span class="kw">frm_plot</span> <span class="op">+</span>
    <span class="fu">geom_point</span>(<span class="kw">frm_labels</span>, mapping = <span class="fu">aes</span>(x = <span class="kw">s</span>, y = <span class="kw">wp</span>),
               color = <span class="st">"#000000"</span>, size = <span class="fl">2</span>, show.legend = <span class="fl">FALSE</span>) <span class="op">+</span>
    <span class="fu">geom_segment</span>(<span class="kw">frm_labels</span>, mapping = <span class="fu">aes</span>(x = <span class="kw">x_text</span>, xend = <span class="kw">s</span>, y = <span class="kw">y_text</span>, yend = <span class="kw">wp</span>),
                 linetype = <span class="st">"dashed"</span>, color = <span class="st">"#000000"</span>, na.rm=<span class="fl">TRUE</span>) <span class="op">+</span>
    <span class="fu">geom_label</span>(<span class="kw">frm_labels</span>, mapping = <span class="fu">aes</span>(x = <span class="kw">x_text</span>, y = <span class="kw">y_text</span>, label = <span class="kw">text</span>),
               size = <span class="fl">3</span>, color = <span class="st">"#000000"</span>, na.rm = <span class="fl">TRUE</span>, alpha = <span class="fl">0.8</span>)
  
  <span class="co"># plot the frame</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">frm_plot</span>, width = <span class="fl">12.5</span>, height = <span class="fl">6.47</span>, dpi = <span class="fl">500</span>)
}
</pre></div>
<p>Let’s test our function to make sure the plot looks like how we want it by running our function with 6 minutes left in the game.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu">draw_frame</span>(<span class="fl">360</span>)
</pre></div>
<p><img src="Animated_WP_Plotting_files/figure-html/draw_test-1.png" width="700"></p>
<p>Looks great, so next we create the <code>draw_game()</code> function which will draw every frame for our GIF.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">draw_game</span> <span class="op">&lt;-</span> <span class="fu">function</span>()
{
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>, <span class="fu">function</span>(<span class="kw">n_sec</span>)
  { 
    <span class="fu">draw_frame</span>(<span class="kw">n_sec</span>)
  })
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Plotting frames for pause"</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span>(<span class="fl">40</span>, <span class="fu">draw_frame</span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="kw">wp_data</span><span class="op">$</span><span class="kw">s</span>)))
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Assembling plots into a GIF"</span>)
}
</pre></div>
</div>
<div id="animating" class="section level2">
<h2 class="hasAnchor">
<a href="#animating" class="anchor"></a>Animating</h2>
<p>Finally, we run our <code>draw_game()</code> function inside of <code><a href="https://rdrr.io/pkg/animation/man/saveGIF.html">saveGIF()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="co"># saveGIF(draw_game(), interval = 0.1, movie.name = "animated_wp.gif")</span>
</pre></div>
<p><img src="https://github.com/saiemgilani/cfbscrapR/blob/master/man/figures/animated_wp.gif?raw=true" alt="Result"> This process takes awhile, about 3 minutes on my computer. We can also re-size our GIF using the <code>ani.width</code>, <code>ani.height</code> and <code>ani.res</code> parameters. I like to make my plots wider and at higher resolution, but be careful, this will drastically increase the rendering time and the file size.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="co"># saveGIF(draw_game(), interval = 0.1, movie.name = "animated_wp_wide.gif",</span>
<span class="co">#         ani.width = 1000, ani.height = 650, ani.res = 110)</span>
</pre></div>
<div class="figure">
<img src="https://kazink36.github.io/images/animated_wp_ex_wide.gif" alt=""><p class="caption">Result</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/saiemgilani">Saiem Gilani</a>, <a href="https://twitter.com/msubbaiah1">Meyappan Subbaiah</a>, <a href="https://twitter.com/statsowar">Parker Fleming</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
