<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rolling EPA Graph • cfbscrapR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Rolling EPA Graph">
<meta property="og:description" content="cfbscrapR">
<meta property="og:image" content="https://raw.githubusercontent.com/saiemgilani/cfbscrapR/master/man/figures/cfbscrapR.ico">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@cfbscrapR">
<meta name="twitter:site" content="@cfbscrapR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cfbscrapR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-question-circle-o"></span>
     
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Vignettes</a>
    </li>
    <li class="dropdown-header">Introductory</li>
    <li>
      <a href="../articles/Intro.html">CFB Analytics with cfbscrapR</a>
    </li>
    <li>
      <a href="../articles/Animated-WP-Plotting.html">Animated Win Probability Plots</a>
    </li>
    <li>
      <a href="../articles/Fourth-Down-Plot-Tutorial.html">Fourth Down Tendency Plots</a>
    </li>
    <li>
      <a href="../articles/Rolling-EPA-Graph.html">Rolling EPA s</a>
    </li>
    <li class="dropdown-header">Expected Points Model Fundamentals</li>
    <li>
      <a href="../articles/College-Football-Expected-Points-Model-Fundamentals-Part-I.html">Part 1 - Model Definition</a>
    </li>
    <li>
      <a href="../articles/College-Football-Expected-Points-Model-Fundamentals-Part-II.html">Part 2 - Regression Models</a>
    </li>
    <li>
      <a href="../articles/College-Football-Expected-Points-Model-Fundamentals-Part-III.html">Part 3 - History of Expected Points Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    Functions
  </a>
</li>
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/saiemgilani/cfbscrapR-data">
    <span class="fa fa-database"></span>
     
    Data
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/cfbscrapR">
    <span class="fab fa fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/saiemgilani/cfbscrapR/">
    <span class="fa fa-github fa-lg"></span>
     
    GitHub
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Rolling-EPA-Graph_files/header-attrs-2.4/header-attrs.js"></script><script src="Rolling-EPA-Graph_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Rolling EPA Graph</h1>
                        <h4 class="author">Nate Manzo (<span class="citation">@cfbnate</span>)</h4>
            
      
      
      <div class="hidden name"><code>Rolling-EPA-Graph.rmd</code></div>

    </div>

    
    
<p>This vignette will use data from the <code>cfbscrapR</code> package to create a moving average graph of offensive EPA over the course of a season. This lets us visualize how a team’s performance has changed over time and compare that performance to other teams around the country.</p>
<div id="install-the-necessary-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#install-the-necessary-packages" class="anchor"></a>Install the necessary packages</h2>
<p>You’ll want to make sure the following packages are installed. Run these lines without the “#” to install them. If you have already installed these packages you can skip this step.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co">#install.packages('tidyverse')</span>
<span class="co">#install.packages("devtools")</span>
<span class="co">#install.packages("zoo")</span>
<span class="co">#install.packages("ggimage")</span>
<span class="co">#devtools::install_github("saiemgilani/cfbscrapR")</span>
</pre></div>
</div>
<div id="load-the-necessary-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#load-the-necessary-packages" class="anchor"></a>Load the necessary packages</h2>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://www.github.com/saiemgilani/cfbscrapR">cfbscrapR</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://zoo.R-Forge.R-project.org">zoo</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/GuangchuangYu/ggimage">ggimage</a></span>)
</pre></div>
</div>
<div id="pull-the-play-by-play-data" class="section level2">
<h2 class="hasAnchor">
<a href="#pull-the-play-by-play-data" class="anchor"></a>Pull the play by play data</h2>
<p>In the interest of time, I’m going to avoid a fresh call to the API here and I’m going to use a copy of the play by play data that is saved on github. This method only takes about 30 seconds. The result will be a dataframe that contains ALL of the play by play data for ALL teams in 2020.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>()
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(<span class="st">"https://raw.githubusercontent.com/saiemgilani/cfbscrapR-data/master/data/rds/pbp_players_pos_2020.rds"</span>,<span class="kw">t</span>)
<span class="kw">pbp_2020</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="kw">t</span>)
</pre></div>
</div>
<div id="pull-team-info-and-team-colors" class="section level2">
<h2 class="hasAnchor">
<a href="#pull-team-info-and-team-colors" class="anchor"></a>Pull team info and team colors</h2>
<p>We can use the <code><a href="../reference/cfb_team_info.html">cfb_team_info()</a></code> function to pull information about each FBS school including their logo, color, and abbreviation. We’re going to take a subset of the cfb_team_info data and clean it up for use in our graphs later on.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">team_info</span> <span class="op">=</span> <span class="fu"><a href="../reference/cfb_team_info.html">cfb_team_info</a></span>(year = <span class="fl">2020</span>)

<span class="kw">team_colors_logos</span> <span class="op">=</span> <span class="kw">team_info</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span>(<span class="kw">school</span>, <span class="kw">abbreviation</span>, <span class="kw">color</span>, <span class="kw">logos</span>, <span class="kw">alt_color</span>) <span class="op">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="kw">logos</span>) <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">school</span>) <span class="op">%&gt;%</span>
  <span class="fu">slice</span>(<span class="fl">1</span>) <span class="op">%&gt;%</span> 
  <span class="fu">ungroup</span>()
</pre></div>
</div>
<div id="basic-overview-of-all-fbs-offenses" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-overview-of-all-fbs-offenses" class="anchor"></a>Basic overview of all FBS Offenses</h2>
<p>Let’s create a basic overview of offensive EPA per play. We’ll start by creating a dataframe listing all 130 FBS teams from best to worst based on their average EPA per play across all games played.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">off_epa</span> <span class="op">=</span> <span class="kw">pbp_2020</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">rush</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">pass</span> <span class="op">==</span> <span class="fl">1</span>) <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span>(<span class="kw">offense_play</span>, <span class="kw">offense_conference</span>) <span class="op">%&gt;%</span>
  <span class="fu">summarize</span>(off_epa = <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">EPA</span>, na.rm = <span class="fl">TRUE</span>)) <span class="op">%&gt;%</span>
  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="kw">off_epa</span>)) <span class="op">%&gt;%</span>
  <span class="fu">rename</span>(Team = <span class="kw">offense_play</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">offense_conference</span>)) <span class="op">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(Rank = <span class="fu">row_number</span>()) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(TeamRank = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">Team</span>, <span class="st">" #"</span>, <span class="kw">Rank</span>))
</pre></div>
<p>We can use the <code><a href="https://rdrr.io/r/utils/head.html">head()</a></code> function to take a quick peak at what our new dataframe looks like. The teams at the top should not be surprising. Remember, EPA is not adjusted for the strength of opponent. It is purely a measure of how teams perform on the field (like yards, but better).</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw">off_epa</span>)
</pre></div>
<pre><code>## # A tibble: 6 x 5
##   Team        offense_conference off_epa  Rank TeamRank      
##   &lt;chr&gt;       &lt;chr&gt;                &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;         
## 1 Ohio State  Big Ten              0.434     1 Ohio State #1 
## 2 Michigan    Big Ten              0.388     2 Michigan #2   
## 3 Alabama     SEC                  0.325     3 Alabama #3    
## 4 Wisconsin   Big Ten              0.310     4 Wisconsin #4  
## 5 Boise State Mountain West        0.291     5 Boise State #5
## 6 Florida     SEC                  0.281     6 Florida #6</code></pre>
<p>Ok, now let’s start to visualize the data beyond the top few schools. Let’s graph all the teams that have a positive EPA on the year.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">off_epa</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">off_epa</span> <span class="op">&gt;</span> <span class="fl">0</span>) <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(x = <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span>(<span class="kw">TeamRank</span>, <span class="kw">off_epa</span>), y=<span class="kw">off_epa</span>)) <span class="op">+</span>
  <span class="fu">geom_point</span>(size = <span class="fl">3</span>) <span class="op">+</span>
  <span class="fu">coord_flip</span>() <span class="op">+</span>
  <span class="fu">theme_bw</span>() <span class="op">+</span>
  <span class="fu">ylab</span>(<span class="st">"Average EPA Per Play"</span>) <span class="op">+</span> <span class="fu">xlab</span>(<span class="st">""</span>) <span class="op">+</span>
  <span class="fu">labs</span>(title = <span class="st">"Offensive EPA Per Play | Positive EPA Teams"</span>,
       caption = <span class="st">"Chart by @cfbNate
       Data from @CFB_Data via @cfbscrapr"</span>) 
</pre></div>
<p><img src="Rolling-EPA-Graph_files/figure-html/graph_top_offenses-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="prepare-the-data-for-the-moving-average-chart" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-the-data-for-the-moving-average-chart" class="anchor"></a>Prepare the data for the moving average chart</h2>
<p>So far, so good, but we came here to build a moving average chart! Let’s proceed by defining the team of interest and the moving average window by editing the cell block below. I like to use 100 plays when looking at a full season to smooth out as much of the variability as possible, but for a mid-season view 50 plays or even 25 plays might be more appropriate. Play around!</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">team</span> <span class="op">=</span> <span class="st">"Oklahoma"</span>
<span class="kw">ma_plays</span> <span class="op">=</span> <span class="fl">100</span>
</pre></div>
<p>Now that we have defined our team of interest, we can prepare the data for this specific team. We’re going to create a dataframe called <code>team_off</code> that is subsetted from our full season play by play data. This new dataframe will be specific to our team of interest and it will add fields for the moving average and the play count.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">team_off</span> <span class="op">=</span> <span class="kw">pbp_2020</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">offense_play</span> <span class="op">==</span> <span class="kw">team</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">rush</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="kw">pass</span> <span class="op">==</span> <span class="fl">1</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="kw">EPA</span>)) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(cu_epa=<span class="fu">cummean</span>(<span class="kw">EPA</span>),  <span class="co">#this field is not used in this vignette but it could be substituted later to graph the cumulative EPA</span>
         ma_epa=<span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollapply.html">rollapply</a></span>(<span class="kw">EPA</span>,<span class="kw">ma_plays</span>,<span class="kw">mean</span>,align=<span class="st">'right'</span>,fill=<span class="fl">NA</span>),
         play_count = <span class="fu">row_number</span>(),
         week_team = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"WK"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="kw">week</span> <span class="op">&gt;</span> <span class="fl">9</span>, <span class="kw">week</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="fl">0</span>,<span class="kw">week</span>)), <span class="st">" "</span>, <span class="kw">defense_play</span>))
</pre></div>
<p>We’re going to graph different background tiles for each opponent so we need to define where one opponent stops and another one begins.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">team_off_play_start</span> <span class="op">=</span> <span class="kw">team_off</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">week_team</span>) <span class="op">%&gt;%</span>
  <span class="fu">slice</span>(<span class="fl">1</span>) <span class="op">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">defense_play</span>, <span class="kw">week_team</span>, <span class="kw">play_count</span>) <span class="op">%&gt;%</span>
  <span class="fu">rename</span>(play_start = <span class="kw">play_count</span>,
         team = <span class="kw">defense_play</span>)

<span class="kw">team_off_play_stop</span> <span class="op">=</span> <span class="kw">team_off</span> <span class="op">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="kw">week_team</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">row_number</span>() <span class="op">==</span> <span class="fu">n</span>()) <span class="op">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">week_team</span>, <span class="kw">play_count</span>) <span class="op">%&gt;%</span>
  <span class="fu">rename</span>(play_stop = <span class="kw">play_count</span>)
</pre></div>
<p>We’re going to add the opponent’s logo in the middle of each background tile, so we need to define the midpoint of each background tile as well.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw">team_off_start_stop</span> <span class="op">=</span> <span class="kw">team_off_play_start</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="kw">team_off_play_stop</span>, by = <span class="st">"week_team"</span>) <span class="op">%&gt;%</span>
  <span class="fu">mutate</span>(midpoint = (<span class="kw">play_start</span> <span class="op">+</span> <span class="kw">play_stop</span>)<span class="op">/</span><span class="fl">2</span>)
</pre></div>
<p>We need to make a simple vector that says how many total plays are in our <code>team_off</code> dataframe.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">play_count</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="kw">team_off</span><span class="op">$</span><span class="kw">play_count</span>)
</pre></div>
<p>Next we are going to update our background tile dataframe to include the color info that we pulled earlier. FCS color data is not available, so we will default those to gray.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">team_off_start_stop</span> <span class="op">=</span> <span class="kw">team_off_start_stop</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span>(<span class="kw">team_colors_logos</span>, by = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"team"</span> = <span class="st">"school"</span>)) <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span>(color = <span class="fu">replace_na</span>(<span class="kw">color</span>,<span class="st">"gray"</span>)) <span class="op">%&gt;%</span>
  <span class="fu">select</span>(<span class="kw">team</span>, <span class="kw">week_team</span>, <span class="kw">play_start</span>, <span class="kw">play_stop</span>, <span class="kw">midpoint</span>, <span class="kw">color</span>)
</pre></div>
<p>Are we ready to graph yet? Just a few more steps! We need a named vector to get the right colors on those background tiles.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="kw">team_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw">team_off_start_stop</span><span class="op">$</span><span class="kw">color</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">team_colors</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="kw">team_off_start_stop</span><span class="op">$</span><span class="kw">team</span>)
</pre></div>
<p>Now we need to pull in an alternate source of team logos that includes FCS schools. Then we’ll join that new table of logos with our background tile dataframe.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="kw">all_logos</span> <span class="op">=</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/natemanzo/cfb_data/master/_team_logos.csv"</span>)

<span class="kw">team_off_start_stop</span> <span class="op">=</span> <span class="kw">team_off_start_stop</span> <span class="op">%&gt;%</span> 
  <span class="fu">left_join</span>(<span class="kw">all_logos</span>, by = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"team"</span> = <span class="st">"school"</span>))
</pre></div>
<p>Almost done! The last thing we need is your signature to go in the caption of the graph. You can use your twitter handle or your real name here.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="kw">signature</span> <span class="op">=</span> <span class="st">"@cfbNate"</span>
</pre></div>
</div>
<div id="its-graphin-time" class="section level2">
<h2 class="hasAnchor">
<a href="#its-graphin-time" class="anchor"></a>IT’S GRAPHIN’ TIME*</h2>
<p><sup>*To be said in an extremely Power Rangers voice</sup></p>
<p>The beginning of the line graph will depend on the <code>ma_plays</code> variable that you defined earlier. Dashed lines indicating the EPA/play of the 25th percentile, median, 75th percentile, and top and bottom teams in the country are drawn on the graph to show context for how the team of interest compares to the rest of the country.</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="kw">graph_team_off</span> <span class="op">=</span> <span class="fu">ggplot</span>() <span class="op">+</span>
  <span class="fu">geom_rect</span>(data = <span class="kw">team_off_start_stop</span>, <span class="fu">aes</span>(xmin = <span class="kw">play_start</span>, xmax = <span class="kw">play_stop</span>, fill = <span class="kw">team</span>, ymin = <span class="op">-</span><span class="fl">.5</span>, ymax = <span class="fl">.9</span>), color = <span class="st">"gray90"</span>) <span class="op">+</span>
  <span class="fu">geom_rect</span>(data = <span class="kw">team_off_start_stop</span>, <span class="fu">aes</span>(xmin = <span class="kw">play_start</span>, xmax = <span class="kw">play_stop</span>, ymin = <span class="fl">.8</span>, ymax = <span class="fl">1</span>), color = <span class="st">"gray90"</span>, fill = <span class="st">"white"</span>) <span class="op">+</span>
  <span class="fu">scale_fill_manual</span>(values = <span class="kw">team_colors</span>) <span class="op">+</span>
  <span class="fu">geom_hline</span>(yintercept = <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">off_epa</span><span class="op">$</span><span class="kw">off_epa</span>), linetype = <span class="fl">2</span>, color = <span class="st">"gray20"</span>, alpha = <span class="fl">.8</span>) <span class="op">+</span>
  <span class="fu">geom_hline</span>(yintercept = <span class="fl">0</span>, linetype = <span class="fl">1</span>, color = <span class="st">"gray20"</span>, alpha = <span class="fl">.2</span>) <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggimage/man/geom_image.html">geom_image</a></span>(data=<span class="kw">team_off_start_stop</span>,<span class="fu">aes</span>(x=<span class="kw">midpoint</span>,y=<span class="fl">.9</span>,image=<span class="kw">logo</span>), asp = <span class="fl">16</span><span class="op">/</span><span class="fl">9</span>, size = <span class="fl">.05</span>) <span class="op">+</span>
  <span class="fu">annotate</span>(x = <span class="op">-</span><span class="fl">2</span>, y = <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">off_epa</span><span class="op">$</span><span class="kw">off_epa</span>)[<span class="fl">1</span>], geom = <span class="st">"text"</span>, size = <span class="fl">3</span>, hjust = <span class="st">"right"</span>, vjust = <span class="fl">0</span>, label = <span class="kw">off_epa</span> <span class="op">%&gt;%</span> <span class="fu">slice</span>(<span class="fu">n</span>()) <span class="op">%&gt;%</span> <span class="fu">pull</span>(<span class="kw">Team</span>)) <span class="op">+</span>
  <span class="fu">annotate</span>(x = <span class="op">-</span><span class="fl">2</span>, y = <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">off_epa</span><span class="op">$</span><span class="kw">off_epa</span>)[<span class="fl">2</span>], geom = <span class="st">"text"</span>, size = <span class="fl">3</span>, hjust = <span class="st">"right"</span>, vjust = <span class="fl">0</span>, label = <span class="st">"25%ile"</span>) <span class="op">+</span>
  <span class="fu">annotate</span>(x = <span class="op">-</span><span class="fl">2</span>, y = <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">off_epa</span><span class="op">$</span><span class="kw">off_epa</span>)[<span class="fl">3</span>], geom = <span class="st">"text"</span>, size = <span class="fl">3</span>, hjust = <span class="st">"right"</span>, vjust = <span class="fl">0</span>, label = <span class="st">"Median"</span>) <span class="op">+</span>
  <span class="fu">annotate</span>(x = <span class="op">-</span><span class="fl">2</span>, y = <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">off_epa</span><span class="op">$</span><span class="kw">off_epa</span>)[<span class="fl">4</span>], geom = <span class="st">"text"</span>, size = <span class="fl">3</span>, hjust = <span class="st">"right"</span>, vjust = <span class="fl">0</span>, label = <span class="st">"75%ile"</span>) <span class="op">+</span>
  <span class="fu">annotate</span>(x = <span class="op">-</span><span class="fl">2</span>, y = <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="kw">off_epa</span><span class="op">$</span><span class="kw">off_epa</span>)[<span class="fl">5</span>], geom = <span class="st">"text"</span>, size = <span class="fl">3</span>, hjust = <span class="st">"right"</span>, vjust = <span class="fl">0</span>, label = <span class="kw">off_epa</span> <span class="op">%&gt;%</span> <span class="fu">slice</span>(<span class="fl">1</span>) <span class="op">%&gt;%</span> <span class="fu">pull</span>(<span class="kw">Team</span>)) <span class="op">+</span>
  <span class="fu">geom_line</span>(data = <span class="kw">team_off</span>, <span class="fu">aes</span>(x = <span class="kw">play_count</span>, y = <span class="kw">ma_epa</span>), color = <span class="st">"white"</span>, size = <span class="fl">2</span>) <span class="op">+</span>
  <span class="fu">geom_line</span>(data = <span class="kw">team_off</span>, <span class="fu">aes</span>(x = <span class="kw">play_count</span>, y = <span class="kw">ma_epa</span>), size = <span class="fl">1.25</span>) <span class="op">+</span>
  <span class="fu">theme_minimal</span>() <span class="op">+</span> <span class="fu">theme</span>(panel.grid = <span class="fu">element_blank</span>()) <span class="op">+</span> <span class="fu">theme</span>(legend.position = <span class="st">"none"</span>) <span class="op">+</span>
  <span class="fu">ylab</span>(<span class="st">"EPA"</span>) <span class="op">+</span> <span class="fu">xlab</span>(<span class="st">"Number of Plays"</span>) <span class="op">+</span>
  <span class="fu">labs</span>(title = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="kw">team</span>,<span class="st">" Offensive EPA | "</span>,<span class="kw">ma_plays</span>,<span class="st">"-Play Moving Average"</span>),
       caption = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Chart by "</span>,<span class="kw">signature</span>,<span class="st">" using code from @cfbNate
       Data from @CFB_Data via @cfbscrapr"</span>)) <span class="op">+</span>
  <span class="fu">coord_cartesian</span>(xlim = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span><span class="fl">20</span>, <span class="kw">play_count</span>),  <span class="co"># This leaves room for the labels over the dashed lines</span>
                  clip = <span class="st">'off'</span>)               <span class="co"># This keeps the labels from disappearing</span>

<span class="kw">graph_team_off</span>
</pre></div>
<p><img src="Rolling-EPA-Graph_files/figure-html/graph_the_graph-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Lastly, you can save your graph to your working directory by running the line below. PC users will notice the saved graphic will have a higher resolution and less pixelization than the graphic generated above.</p>
<p>Reminder: You can always use <code><a href="https://rdrr.io/r/base/getwd.html">getwd()</a></code> to find out what your current working directory is if you’re not sure.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="fu">ggsave</span>(<span class="kw">graph_team_off</span>, filename = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"off_epa_rolling_"</span>,<span class="kw">team</span>,<span class="st">".png"</span>), 
       dpi = <span class="fl">300</span>, type = <span class="st">"cairo"</span>, width = <span class="fl">10</span>, height = <span class="fl">7</span>, units = <span class="st">"in"</span>)
</pre></div>
<p>I hope you found this useful! As always, thanks to <a href="https://twitter.com/CFB_Data">@CFB_Data</a> and the <a href="https://twitter.com/cfbscrapR">@cfbscrapR</a> team for making this possible. And shout out to folks like Parker Fleming and Meyappan Subbaiah for their feedback, advice, and encouragement while refining the look of this visualization. Tag me in any of these graphs you post on twitter and I’ll share them as much as possible.</p>
<p>-<a href="https://twitter.com/cfbNate">Nate Manzo</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/saiemgilani">Saiem Gilani</a>, <a href="https://twitter.com/msubbaiah1">Meyappan Subbaiah</a>, <a href="https://twitter.com/statsowar">Parker Fleming</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
